<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Sheet Link Extraction</title>
</head>
<body>
    <h1>Link Extraction Test</h1>
    <div id="results"></div>
    
    <script>
        async function extractLinks() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Loading...</p>';
            
            try {
                // Fetch the GVIZ JSON with formula data
                const response = await fetch('https://docs.google.com/spreadsheets/d/1mgeVYCf9a9zuEla6YfbNqceOsBRXA08YOc3rGuZtDx8/gviz/tq?tqx=out:json&headers=1');
                const text = await response.text();
                
                // Extract JSON from callback wrapper
                const match = text.match(/\*\/\s*(.+?)\)\s*$/s);
                if (!match) throw new Error('Failed to parse GVIZ response');
                
                const jsonStr = match[1].replace(/\);$/, '');
                const data = JSON.parse(jsonStr);
                
                const rows = data.table.rows;
                let linkCount = 0;
                
                results.innerHTML = '<ul>';
                
                for (let i = 0; i < Math.min(rows.length, 5); i++) {
                    const cells = rows[i].c || [];
                    
                    // Check columns H, I, J (indices 7, 8, 9)
                    for (let colIndex of [7, 8, 9]) {
                        if (cells[colIndex]) {
                            const cell = cells[colIndex];
                            console.log(`Row ${i+1}, Col ${colIndex}:`, cell);
                            
                            // Check all properties
                            const props = Object.keys(cell);
                            console.log('Properties:', props);
                            
                            if (cell.f) {
                                const formula = typeof cell.f === 'object' ? cell.f.v : cell.f;
                                console.log('Formula:', formula);
                                
                                // Try to extract URL from HYPERLINK formula
                                const urlMatch = formula?.match(/HYPERLINK\s*\(\s*"([^"]+)"/i);
                                if (urlMatch) {
                                    linkCount++;
                                    results.innerHTML += `<li>Found URL: ${urlMatch[1]}</li>`;
                                }
                            }
                        }
                    }
                }
                
                results.innerHTML += '</ul><p>Total links found: ' + linkCount + '</p>';
                
            } catch (error) {
                results.innerHTML = '<p style="color:red;">Error: ' + error.message + '</p>';
                console.error(error);
            }
        }
        
        window.onload = extractLinks;
    </script>
</body>
</html>
